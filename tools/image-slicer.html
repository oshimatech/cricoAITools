<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Grid Slicer - ç”»åƒåˆ†å‰²ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
    </style>
</head>

<body class="min-h-screen p-4 flex flex-col items-center">
    <a href="../index.html" class="absolute top-4 left-4 text-gray-400 hover:text-white mb-4 z-10">
        &larr; ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
    </a>

    <!-- ... (User Code) ... -->
    <!-- I will paste the FULL user code here, wrapped in the body/head structure properly -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ */
        #drop-zone {
            border: 2px dashed #4a5568;
            transition: all 0.3s ease;
        }

        #drop-zone.dragover {
            border-color: #48bb78;
            background-color: rgba(72, 187, 120, 0.1);
        }

        /* ã‚¹ãƒ©ã‚¤ã‚¹ã•ã‚ŒãŸç”»åƒã®ã‚«ãƒ¼ãƒ‰ */
        .slice-card {
            aspect-ratio: 16 / 9;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            overflow: hidden;
            position: relative;
        }

        .slice-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .slice-number {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>

    <header class="w-full max-w-5xl flex justify-between items-center mb-8 mt-8">
        <div>
            <h1 class="text-2xl font-bold text-white">AI ã‚°ãƒªãƒƒãƒ‰åˆ†å‰² <span class="text-green-400">âœ‚ï¸</span></h1>
            <p class="text-gray-400 text-sm">ã‚°ãƒªãƒƒãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å€‹åˆ¥ã®ç”»åƒã«åˆ‡ã‚Šå‡ºã—ï¼†ZIPä¿å­˜</p>
        </div>
        <button id="download-btn" disabled
            class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <span>ğŸ“¦ ZIPã§ä¿å­˜</span>
        </button>
    </header>

    <main class="w-full max-w-5xl space-y-8">

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">

                <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                <div class="flex-1 w-full">
                    <div id="drop-zone"
                        class="w-full h-32 rounded-lg flex flex-col items-center justify-center text-gray-500 cursor-pointer bg-gray-900 hover:bg-gray-800">
                        <input type="file" id="file-input" accept="image/*" class="hidden">
                        <svg class="w-8 h-8 mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        <p class="text-sm">ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã€ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                        <p class="text-xs text-gray-600 mt-1">ï¼ˆåˆ†å‰²ã•ã‚ŒãŸå…ƒã®ç”»åƒ1æšï¼‰</p>
                    </div>
                </div>

                <!-- è¨­å®šã‚¨ãƒªã‚¢ -->
                <div class="flex flex-col gap-3 min-w-[200px]">
                    <label class="text-sm text-gray-300 font-bold">åˆ†å‰²ãƒ¢ãƒ¼ãƒ‰è¨­å®š:</label>
                    <select id="split-mode"
                        class="bg-gray-700 text-white border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-green-500">
                        <option value="3x3">3 x 3 (9åˆ†å‰²)</option>
                        <option value="2x2">2 x 2 (4åˆ†å‰²)</option>
                        <option value="2x1">2 x 1 (å·¦å³2åˆ†å‰²)</option>
                        <option value="3x2">3 x 2 (6åˆ†å‰²)</option>
                    </select>
                    <button id="process-btn" disabled
                        class="bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded transition text-sm w-full disabled:opacity-50">
                        ã‚¹ãƒ©ã‚¤ã‚¹å®Ÿè¡Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div id="preview-area" class="hidden">
            <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                <span id="result-count" class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">0æš</span>
            </h3>

            <!-- ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠ -->
            <div id="grid-container" class="grid gap-4 grid-cols-3">
                <!-- ã“ã“ã«åˆ‡ã‚Šå‡ºã•ã‚ŒãŸç”»åƒãŒè¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>

    </main>

    <!-- å‡¦ç†ç”¨éš ã—ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <canvas id="process-canvas" class="hidden"></canvas>

    <script>
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const splitModeSelect = document.getElementById('split-mode');
        const processBtn = document.getElementById('process-btn');
        const downloadBtn = document.getElementById('download-btn');
        const gridContainer = document.getElementById('grid-container');
        const previewArea = document.getElementById('preview-area');
        const resultCount = document.getElementById('result-count');
        const canvas = document.getElementById('process-canvas');
        const ctx = canvas.getContext('2d');

        let originalImage = null;
        let slicedBlobs = []; // { blob, filename }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function handleFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    processBtn.disabled = false;
                    dropZone.innerHTML = `<p class="text-green-400 font-bold">âœ“ ${file.name}</p><p class="text-xs text-gray-500">${img.width}x${img.height}</p>`;
                    // è‡ªå‹•ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã—ãŸã„å ´åˆã¯ã“ã“ã§ updatePreview() ã‚’å‘¼ã¶
                    updatePreview(); // è‡ªå‹•å®Ÿè¡Œ
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ã‚¹ãƒ©ã‚¤ã‚¹å‡¦ç†
        async function updatePreview() {
            if (!originalImage) return;

            // ãƒªã‚»ãƒƒãƒˆ
            gridContainer.innerHTML = '';
            slicedBlobs = [];
            downloadBtn.disabled = true;
            previewArea.classList.remove('hidden');

            const mode = splitModeSelect.value;
            let cols = 3, rows = 3;

            // ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
            if (mode === '3x3') { cols = 3; rows = 3; }
            else if (mode === '2x2') { cols = 2; rows = 2; }
            else if (mode === '2x1') { cols = 2; rows = 1; }
            else if (mode === '3x2') { cols = 3; rows = 2; }

            // è¡¨ç¤ºç”¨ã‚°ãƒªãƒƒãƒ‰ã®CSSã‚«ãƒ©ãƒ æ•°ã‚’å¤‰æ›´
            gridContainer.className = `grid gap-4 grid-cols-${cols}`;

            const totalWidth = originalImage.width;
            const totalHeight = originalImage.height;
            const cellWidth = totalWidth / cols;
            const cellHeight = totalHeight / rows;

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’1ã‚»ãƒ«åˆ†ã«ã™ã‚‹ï¼ˆé«˜ç”»è³ªç¶­æŒã®ãŸã‚ï¼‰
            // æ³¨æ„: ãƒ«ãƒ¼ãƒ—ã”ã¨ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æãç›´ã™

            let count = 0;

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    count++;

                    // å€‹åˆ¥ã®ã‚»ãƒ«ç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆï¼ˆãƒªã‚µã‚¤ã‚ºå‡¦ç†ç”¨ï¼‰
                    const cellCanvas = document.createElement('canvas');
                    cellCanvas.width = cellWidth;
                    cellCanvas.height = cellHeight;
                    const cellCtx = cellCanvas.getContext('2d');

                    // å…ƒç”»åƒã®è©²å½“éƒ¨åˆ†ã‚’æç”»
                    cellCtx.drawImage(
                        originalImage,
                        x * cellWidth, y * cellHeight, cellWidth, cellHeight, // ã‚½ãƒ¼ã‚¹é ˜åŸŸ
                        0, 0, cellWidth, cellHeight // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé ˜åŸŸ
                    );

                    // BlobåŒ–ã—ã¦ä¿å­˜
                    const blob = await new Promise(resolve => cellCanvas.toBlob(resolve, 'image/png'));
                    const url = URL.createObjectURL(blob);
                    const filename = `slice_${count.toString().padStart(2, '0')}.png`;

                    slicedBlobs.push({ blob, filename });

                    // UIã«ã‚«ãƒ¼ãƒ‰è¿½åŠ 
                    const card = document.createElement('div');
                    card.className = 'slice-card rounded-lg shadow-lg';
                    card.innerHTML = `
                        <img src="${url}" alt="Slice ${count}">
                        <div class="slice-number">#${count}</div>
                    `;
                    gridContainer.appendChild(card);
                }
            }

            resultCount.textContent = `${count}æš`;
            downloadBtn.disabled = false;
        }

        // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        downloadBtn.addEventListener('click', async () => {
            if (slicedBlobs.length === 0) return;

            const zip = new JSZip();
            const folder = zip.folder("slices");

            slicedBlobs.forEach(item => {
                folder.file(item.filename, item.blob);
            });

            // æ—¥æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å
            const now = new Date();
            const timestamp = now.toISOString().replace(/[-:T.]/g, '').slice(0, 14);

            const content = await zip.generateAsync({ type: "blob" });

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆ
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `slices_${timestamp}.zip`;
            link.click();
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        processBtn.addEventListener('click', updatePreview);
        splitModeSelect.addEventListener('change', () => {
            if (originalImage) updatePreview();
        });

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
    </script>
</body>

</html>